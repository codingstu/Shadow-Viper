# 🎯 HTTP 502 诊断决策树

## 快速诊断工具

### 问题: 看到 HTTP 502 错误

```
我看到 HTTP 502 错误
    ↓
这是代码问题吗？
```

---

## 决策树第一层：区分代码问题 vs 节点问题

```
┌─────────────────────────────────────────────────────────────────────┐
│  关键问题: "Clash 代理启动成功了吗？"                               │
└─────────────────────────────────────────────────────────────────────┘

我们的代码:
  ├─ 步骤1: 启动 Clash 进程
  ├─ 步骤2: 等待 3 秒
  ├─ 步骤3: 发送 HTTP 请求
  └─ 步骤4: 获取响应

如果看到 502:
  ✅ 说明步骤1-3 都成功了
  ✅ Clash 接收了我们的请求
  ✅ Clash 尝试转发到节点
  ❌ 节点无响应 → 502

如果代码有问题，会看到:
  ❌ "连接拒绝" → Clash 没启动
  ❌ "连接超时" → Clash 没就绪
  ❌ 其他异常 → 代码逻辑错误
```

---

## 决策树第二层：确定节点问题的根因

```
┌─────────────────────────────────────────────────────────────┐
│  我看到大量 502 错误 (比如 50/50)                          │
└─────────────────────────────────────────────────────────────┘

              ↓

┌─ 这批节点来自哪个源？
│
├─ A. 来自多个不同的源
│  ├─ 是否不同协议也都失败？
│  │  ├─ 是: 极可能是【网络问题】或【源数据质量】
│  │  └─ 否: 可能是【特定协议不兼容】
│  │
│  └─ 是否不同地区也都失败？
│     ├─ 是: 【系统级问题】(ISP 封禁、DNS 污染等)
│     └─ 否: 【地区性问题】(某些 IP 段被限制)
│
├─ B. 来自单个源的节点
│  ├─ 这个源最近更新过吗？
│  │  ├─ 是: 【源本身有问题】
│  │  └─ 否: 【源数据过期】
│  │
│  └─ 历史上这个源的成功率如何？
│     ├─ 很低: 【删除这个源】
│     └─ 很高: 【源临时故障】(等待恢复)
│
└─ C. 我不知道来自哪里
   └─ 【查看日志分析源分布】
```

---

## 快速诊断检查表

### 我现在应该检查什么？

```
┌─────────────────────────────────────┐
│  □ 第一步: 确认不是代码问题        │
└─────────────────────────────────────┘

检查项:
  □ 502 错误重复出现? (说明代码稳定运行)
  □ 错误消息格式一致? (说明代码逻辑正确)
  □ 有时出现 200/204? (说明代码可以获取成功)
  □ 其他错误类型少? (说明不是超时/连接问题)

如果以上都是 ✅:
  → 确认【这是节点问题，不是代码问题】

┌─────────────────────────────────────┐
│  □ 第二步: 分析节点问题根因        │
└─────────────────────────────────────┘

检查项:
  □ 查看日志，502 来自哪些源?
  □ 不同源的成功率有差异吗?
  □ 特定国家的节点都失败吗?
  □ 特定协议的节点都失败吗?

典型发现:
  发现1: "源A: 0%, 源B: 15%, 源C: 3%"
    → 【源 A 有问题，考虑删除】

  发现2: "vless: 0%, vmess: 2%, ss: 5%"
    → 【某些协议兼容性问题】

  发现3: "美国: 0%, 日本: 8%, 新加坡: 12%"
    → 【地区性网络问题】
```

---

## 具体错误类型对照表

### 根据错误信息判断

```
┌─────────────────────────────────┬──────────────┬─────────────────────┐
│ 错误信息                        │ 根本原因     │ 需要修复代码吗?      │
├─────────────────────────────────┼──────────────┼─────────────────────┤
│ HTTP 502 Bad Gateway            │ 节点无响应   │ ❌ 否，代码正确     │
│ HTTP 503 Service Unavailable    │ 节点无响应   │ ❌ 否，代码正确     │
│ HTTP 504 Gateway Timeout        │ 节点超时     │ ❌ 否，代码正确     │
│ 连接超时 (Connection Timeout)   │ 代理问题*    │ ⚠️  可能              │
│ 连接拒绝 (Connection Refused)   │ 代理启动失败 │ ✅ 是，有代码问题   │
│ SSL/TLS 错误                    │ 协议问题     │ ⚠️  可能              │
│ DNS 解析失败                    │ 网络问题     │ ❌ 否                │
└─────────────────────────────────┴──────────────┴─────────────────────┘

*连接超时: 可能是 Clash 还没就绪，正常情况
          或者 Clash 真的启动失败，需要检查
```

---

## 现场诊断流程

### 如果你现在想深入了解 502 原因

```
步骤1: 停止后端，添加诊断代码
───────────────────────────────

在 clash_basic_check.py 的 L145 附近添加:

  logger.info(f"节点 {node.get('name')}: 响应码 {response.status_code}")
  logger.info(f"  来自源: {node.get('add_by')}")
  logger.info(f"  协议: {node.get('type')}")

步骤2: 重启后端并运行一轮检测
───────────────────────────────

bash restart-all-projects.sh

步骤3: 收集详细日志
───────────────────────────────

grep "节点" backend.log | head -50

步骤4: 分析日志找规律
───────────────────────────────

# 按源统计成功率
grep "节点" backend.log | grep -o "来自源:.*" | sort | uniq -c

# 按协议统计
grep "节点" backend.log | grep -o "协议:.*" | sort | uniq -c

步骤5: 形成假说并验证
───────────────────────────────

假说: "所有来自源 X 的 vless 节点都失败"
验证: 统计来自源 X 的 vless 节点，看成功率
```

---

## 502 vs 其他错误的区别

### 如何通过错误区分问题类型

```
我看到 HTTP 502 (BAD GATEWAY)
  ├─ 代理成功启动        ✅
  ├─ 代码发送成功        ✅
  ├─ 代理接收成功        ✅
  └─ 【但节点无响应】    ❌ ← 节点问题

我看到 连接拒绝
  ├─ 代理启动失败        ❌ ← 代码/环境问题
  └─ 需要检查日志

我看到 连接超时
  ├─ 代理还没就绪        ⚠️  可能正常
  ├─ 或代理启动缓慢      ⚠️  环境问题
  └─ 或网络问题          ⚠️  网络问题

我看到 SSL/TLS 错误
  ├─ 协议版本不兼容      ❌ ← 节点问题
  ├─ 证书问题            ❌ ← 节点问题
  └─ Clash 内核问题      ⚠️  少见
```

---

## 502 不需要修复代码的原因

### 逐步分析

```
问题: "为什么 502 不是代码问题？"

理由1: 代码能获取响应
├─ 如果代码有问题，我们拿不到响应
├─ 但我们成功拿到了 502 响应
└─ 说明代码工作正常 ✅

理由2: 502 是 Clash 生成的
├─ 我们没有生成 502 这个状态码
├─ Clash 代理在无法转发时生成
└─ 说明问题在 Clash 下游 ✅

理由3: 其他节点能返回 200/204
├─ 如果代码有问题，应该全失败
├─ 但某些节点返回成功 (200/204)
└─ 说明代码对不同响应都处理正确 ✅

结论: 502 说明代码和代理都工作正常，
      问题在于节点本身无法响应
```

---

## 502 下应该做什么

### 行动计划

```
发现大量 502 → 确认这是节点问题 ✅

┌─ 短期 (立即)
│  ├─ 不修改代码 ✅ (代码无问题)
│  ├─ 继续测试 ✅ (规则1 会快速继续)
│  └─ 收集数据 ✅ (统计哪些源成功)
│
├─ 中期 (1-3 天)
│  ├─ 分析源成功率
│  ├─ 删除失效源
│  ├─ 添加新源
│  └─ 观察成功率趋势
│
└─ 长期 (1 周+)
   ├─ 建立源评分系统
   ├─ 实现源自动轮换
   └─ 优化爬虫策略
```

---

## 最常见的误解

```
❌ 误解1: "502 说明我的代码有问题"
✅ 正确: 502 说明你的代码工作正常，节点有问题

❌ 误解2: "我需要改代码来处理 502"
✅ 正确: 代码已经正确处理 502 了 (标记为不可用)

❌ 误解3: "502 = 严重问题，需要立即修复"
✅ 正确: 502 = 正常诊断信息，节点有问题，继续监控

❌ 误解4: "如果代码没问题，为什么全是 502?"
✅ 正确: 代码完全正确，只是这一批节点确实都离线了

❌ 误解5: "我应该调整超时时间来解决 502"
✅ 正确: 超时时间不会解决 502，是节点本身无响应
```

---

## 💡 重要认知

```
HTTP 502 不是坏消息！

✅ 说明：
  • Clash 代理工作正常
  • 你的代码逻辑正确
  • 网络连接正常
  • 问题诊断准确

❌ 只说明：
  • 这个节点暂时不可用
  • 需要替换节点源

所以 502 其实是：
  "我收到了正确的诊断，这个节点无效，继续下一个"
  
这正是系统应该做的！
```

---

**诊断完成**: 2025-12-31 20:45
**结论**: HTTP 502 = 正常的节点诊断信息，代码无问题
**建议**: 保持现有代码，关注节点源质量
