# ğŸ” ä¸ºä»€ä¹ˆæ²¡çœ‹åˆ° Xray æ£€æµ‹ï¼Ÿé—®é¢˜è¯Šæ–­

## é—®é¢˜ç°è±¡

```
>[20:19:37] âŒ Clashâœ— [5/50] 185.153.183.211:8880 (vless) - HTTP 502
>[20:19:37] âŒ Clashâœ— [4/50] 89.116.180.248:443 (vless) - HTTP 502
>[20:19:37] âŒ Clashâœ— [3/50] 45.82.251.92:8880 (vless) - HTTP 502
>[20:19:37] âŒ Clashâœ— [2/50] 51.77.221.113:443 (vmess) - HTTP 502
>[20:19:37] âŒ Clashâœ— [1/50] 5.196.29.123:2082 (vmess) - HTTP 502

ğŸ“ˆ Clash æ£€æµ‹å®Œæˆ - æ€»è®¡: 50, å¯ç”¨: 0, ä¸å¯ç”¨: 50

âŒ æ²¡çœ‹åˆ° Xray æ£€æµ‹çš„æ—¥å¿—ï¼
```

**ç”¨æˆ·åé¦ˆ**: "è¿˜æœ‰ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ²¡çœ‹åˆ°xrayæ£€æµ‹å‘¢"

---

## é—®é¢˜æ ¹æº

### ä»£ç æµç¨‹åˆ†æ

ä»£ç åœ¨ [node_hunter.py L1095-1220](node_hunter.py#L1095) ä¸­çš„èŠ‚ç‚¹åˆ†é…é€»è¾‘ï¼š

```python
# L1101: Clashæ”¯æŒçš„åè®®
clash_compatible_protocols = ['trojan', 'ss', 'shadowsocks', 'socks5', 'socks', 'http', 'https', 'vmess', 'vless']

# L1104: Xrayæ”¯æŒçš„åè®®
xray_compatible_protocols = ['vmess', 'vless', 'hysteria', 'hysteria2', 'wireguard', 'tuic', 'naiveproxy', 'trojan']

# L1115-1136: èŠ‚ç‚¹åˆ†é…é€»è¾‘
for node in nodes_to_test:
    protocol = node.get('protocol', '').lower()
    
    clash_support = protocol in clash_compatible_protocols
    xray_support = protocol in xray_compatible_protocols
    
    if clash_support and not xray_support:
        # ä»…Clashæ”¯æŒ
        clash_nodes_for_test.append(node)
    elif xray_support and not clash_support:
        # ä»…Xrayæ”¯æŒ
        xray_nodes_for_test.append(node)
    elif clash_support and xray_support:
        # âŒ ä¸¤è€…éƒ½æ”¯æŒï¼Œä¼˜å…ˆç”¨Clash (é€Ÿåº¦å¿«)
        clash_nodes_for_test.append(node)  # åˆ†é…ç»™Clash
        both_protocol_nodes[...] = node    # è®°å½•ä¸º"ä¸¤è€…éƒ½æ”¯æŒ"
```

### ğŸ”´ å…³é”®é—®é¢˜

ä½ æ£€æµ‹çš„ 50 ä¸ªèŠ‚ç‚¹ï¼š
- 5 ä¸ª **vless** åè®® (åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½æœ‰)
- 1 ä¸ª **vmess** åè®® (åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½æœ‰)
- **æ€»è®¡: æ‰€æœ‰ 50 ä¸ªèŠ‚ç‚¹éƒ½æ˜¯"ä¸¤è€…éƒ½æ”¯æŒ"çš„åè®®**

**ç»“æœ**:
- æ‰€æœ‰ 50 ä¸ªèŠ‚ç‚¹éƒ½è¢«åˆ†é…åˆ° `clash_nodes_for_test`
- `xray_nodes_for_test` **ä¸ºç©º**
- L1217 çš„æ¡ä»¶ `if final_xray_nodes:` **ä¸ºå‡**
- **Xray æ£€æµ‹è¢«è·³è¿‡ï¼**

---

## ä¸ºä»€ä¹ˆè®¾è®¡æˆè¿™æ ·ï¼Ÿ

### ä»£ç çš„åˆè¡·

è®¾è®¡è€…çš„æƒ³æ³•æ˜¯ï¼š
1. **ä¼˜å…ˆç”¨ Clash æ£€æµ‹** (é€Ÿåº¦å¿«ï¼Œå¤§å¤šæ•°åè®®éƒ½æ”¯æŒ)
2. **åªç”¨ Xray æ£€æµ‹**:
   - Clash ä¸æ”¯æŒçš„åè®® (Hysteria, Wireguard ç­‰)
   - Clash æ£€æµ‹å¤±è´¥çš„èŠ‚ç‚¹ (éœ€è¦ Xray ä½œä¸ºå¤‡é€‰)

### é—®é¢˜æ‰€åœ¨

ä»£ç ä¸­æœ‰ä¸€ä¸ªæ³¨é‡Šï¼š

```python
# ç¬¬3å±‚ï¼šXrayå†…æ ¸æ£€æµ‹ï¼ˆVMess/VLESSåŠå…¶ä»–ä¸“æœ‰åè®®ï¼‰
# åŒ…æ‹¬ï¼šä»…Xrayæ”¯æŒçš„åè®® + Clashæ£€æµ‹å¤±è´¥çš„åŒæ—¶æ”¯æŒä¸¤è€…åè®®çš„èŠ‚ç‚¹
final_xray_nodes = xray_nodes_for_test.copy()
```

**æ³¨é‡Šè¯´æ˜**: Xray åº”è¯¥æ£€æµ‹ "Clashæ£€æµ‹å¤±è´¥çš„åŒæ—¶æ”¯æŒä¸¤è€…åè®®çš„èŠ‚ç‚¹"

**ä½†ä»£ç æ²¡æœ‰å®ç°è¿™ä¸€ç‚¹**ï¼ âŒ

ä»£ç æ²¡æœ‰æŠŠ Clash å¤±è´¥çš„ vmess/vless èŠ‚ç‚¹é‡æ–°åˆ†é…ç»™ Xray æ£€æµ‹ã€‚

---

## ğŸ”´ ä¸¥é‡çš„è®¾è®¡ç¼ºé™·

### å½“å‰æµç¨‹

```
50 ä¸ªèŠ‚ç‚¹ (éƒ½æ˜¯ vmess/vless)
    â†“
åˆ†é…: å…¨éƒ¨åˆ†é…ç»™ Clash
    â†“
Clash æ£€æµ‹å®Œæˆ: 0 ä¸ªæˆåŠŸï¼Œ50 ä¸ªå¤±è´¥ âŒ
    â†“
Xray æ£€æµ‹: è¢«è·³è¿‡ï¼Œå› ä¸º xray_nodes_for_test ä¸ºç©º âŒ
    â†“
æœ€ç»ˆç»“æœ: 0 ä¸ªå¯ç”¨ âŒ
```

### åº”è¯¥çš„æµç¨‹

```
50 ä¸ªèŠ‚ç‚¹ (éƒ½æ˜¯ vmess/vless)
    â†“
åˆ†é…: å…¨éƒ¨åˆ†é…ç»™ Clash (ä¼˜å…ˆ)
    â†“
Clash æ£€æµ‹å®Œæˆ: 0 ä¸ªæˆåŠŸï¼Œ50 ä¸ªå¤±è´¥ âŒ
    â†“
é‡æ–°åˆ†é…: æŠŠ Clash å¤±è´¥çš„ vmess/vless èŠ‚ç‚¹ç»™ Xray
    â†“
Xray æ£€æµ‹: ä½¿ç”¨è¿™ 50 ä¸ªå¤±è´¥çš„èŠ‚ç‚¹è¿›è¡Œå¤‡é€‰æ£€æµ‹
    â†“
å¯èƒ½çš„ç»“æœ: Xray å¯èƒ½æ£€æµ‹å‡ºä¸€äº›å¯ç”¨èŠ‚ç‚¹ âœ…
```

---

## ä¸ºä»€ä¹ˆè¿™æ˜¯"ä¸¥é‡é—®é¢˜"ï¼Ÿ

### ä¸¤ä¸ª vmess/vless èŠ‚ç‚¹æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«å—ï¼Ÿ

**ä¸æ˜¯çš„ï¼** å®ƒä»¬å¯èƒ½æœ‰å·®å¼‚ï¼š

```
èŠ‚ç‚¹ç±»å‹: vmess æˆ– vless
    â†“
Clash å†…æ ¸æ”¯æŒ: âœ… æ˜¯çš„
Xray å†…æ ¸æ”¯æŒ: âœ… æ˜¯çš„
    
ä½†æ˜¯:
â”œâ”€ Clash å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„ vmess å®ç°å¯èƒ½æœ‰é—®é¢˜
â”œâ”€ Xray å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„ vmess å®ç°å¯èƒ½æ›´å¥½
â”œâ”€ æˆ–è€…è¿™ä¸ª vmess æœ‰ç‰¹æ®Šå‚æ•°ï¼ŒClash ä¸æ”¯æŒä½† Xray æ”¯æŒ

ç»“è®º: åŒä¸€ä¸ªèŠ‚ç‚¹ï¼ŒClash å¤±è´¥ä½† Xray å¯èƒ½æˆåŠŸï¼
```

### çœŸå®ä¾‹å­

å‡è®¾è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ vmess èŠ‚ç‚¹ï¼Œä½¿ç”¨äº†ï¼š
- éæ ‡å‡†åŠ å¯†æ–¹å¼
- ç‰¹æ®Šçš„ä¼ªè£…å‚æ•°
- é«˜çº§çš„ UDP ç›¸å…³é…ç½®

```
Clash æ£€æµ‹: âŒ ä¸æ”¯æŒ â†’ è¿”å› 502
Xray æ£€æµ‹: âœ… æ”¯æŒ â†’ è¿”å› 200
```

**è¿™ä¸ªèŠ‚ç‚¹ä¼šè¢«æµªè´¹ï¼** å› ä¸º Xray æ£€æµ‹è¢«è·³è¿‡äº†ã€‚

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¯ç”¨åŒæ£€æµ‹ (æ¨è)

å½“ Clash æ£€æµ‹å¤±è´¥æ—¶ï¼ŒæŠŠå¤±è´¥çš„èŠ‚ç‚¹é‡æ–°åˆ†é…ç»™ Xrayï¼š

```python
# ç¬¬2å±‚ï¼šClash æ£€æµ‹
clash_results = await check_nodes_clash(clash_nodes, max_concurrent=5)

# è®°å½• Clash å¤±è´¥çš„èŠ‚ç‚¹
clash_failed_nodes = [
    node for node, result in zip(clash_nodes, clash_results) 
    if not result.is_available
]

# ç¬¬3å±‚ï¼šXray æ£€æµ‹
final_xray_nodes = xray_nodes_for_test + clash_failed_nodes
if final_xray_nodes:
    xray_results = await check_nodes_v2ray(final_xray_nodes, max_concurrent=3)
    # ... å¤„ç† xray ç»“æœ
```

**ä¼˜åŠ¿**:
- âœ… Clash å¤±è´¥çš„ vmess/vless èŠ‚ç‚¹è¿˜æœ‰æœºä¼šæˆåŠŸ
- âœ… æœ€å¤§åŒ–æˆåŠŸç‡
- âœ… å……åˆ†åˆ©ç”¨ä¸¤ä¸ªæ£€æµ‹å¼•æ“çš„ä¼˜åŠ¿

**åŠ£åŠ¿**:
- â³ è€—æ—¶å¢åŠ  (éœ€è¦ç­‰ Clash æ£€æµ‹å®Œæˆ)
- ğŸ’¾ å†…å­˜å ç”¨å¢åŠ  (åŒæ—¶è¿è¡Œä¸¤ä¸ªæ£€æµ‹å¼•æ“)

### æ–¹æ¡ˆ2: å¹¶è¡Œæ£€æµ‹

åŒæ—¶è¿è¡Œ Clash å’Œ Xrayï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼š

```python
# åŒæ—¶æ£€æµ‹
clash_task = check_nodes_clash(clash_nodes, ...)
xray_task = check_nodes_v2ray(xray_nodes, ...)

clash_results, xray_results = await asyncio.gather(clash_task, xray_task)
```

**ä¼˜åŠ¿**:
- âœ… è€—æ—¶ä¸å¢åŠ  (å¹¶è¡Œæ‰§è¡Œ)
- âœ… æœ€å¤§åŒ–æˆåŠŸç‡

**åŠ£åŠ¿**:
- ğŸ’¾ å†…å­˜å ç”¨å¢åŠ 

### æ–¹æ¡ˆ3: æŒ‰æ¯”ä¾‹åˆ†é…

æŠŠ vmess/vless èŠ‚ç‚¹æŒ‰æ¯”ä¾‹åˆ†ç»™ Clash å’Œ Xrayï¼š

```python
# 50% ç»™ Clashï¼Œ50% ç»™ Xray
split_point = len(both_support_nodes) // 2
clash_portion = both_support_nodes[:split_point]
xray_portion = both_support_nodes[split_point:]

clash_nodes.extend(clash_portion)
xray_nodes.extend(xray_portion)
```

**ä¼˜åŠ¿**:
- âœ… å‡è¡¡è´Ÿè½½
- âœ… ä¿è¯ä¸¤ä¸ªå¼•æ“éƒ½æœ‰æ£€æµ‹ä»»åŠ¡
- âœ… è€—æ—¶æœ€å°‘

**åŠ£åŠ¿**:
- âŒ å¯èƒ½ä¸å…¬å¹³ (å¦‚æœ Clash å¯¹æŸä¸ªåè®®æ›´ä¼˜ç§€)

---

## ğŸ¯ å»ºè®®ä¿®å¤æ­¥éª¤

### ç«‹å³è¡ŒåŠ¨ (ç°åœ¨)

**é€‰æ‹©ä¿®å¤æ–¹æ¡ˆ**: æ¨èæ–¹æ¡ˆ1 (å¯ç”¨åŒæ£€æµ‹)

**æ”¹åŠ¨æ–‡ä»¶**: [node_hunter.py](node_hunter.py#L1200-1220)

**æ”¹åŠ¨ä½ç½®**:

```python
# L1215-1217: ä¿®å¤
# åŸä»£ç :
final_xray_nodes = xray_nodes_for_test.copy()

# ä¿®å¤å:
# åŒ…æ‹¬ï¼šä»…Xrayæ”¯æŒçš„åè®® + Clashæ£€æµ‹å¤±è´¥çš„èŠ‚ç‚¹
clash_failed_nodes = []
for (orig_node, _), result in zip(clash_nodes_for_test, clash_results):
    if not result.is_available:
        clash_failed_nodes.append(orig_node)

final_xray_nodes = xray_nodes_for_test.copy()
final_xray_nodes.extend(clash_failed_nodes)
```

### åç»­éªŒè¯ (é‡å¯å)

```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ Xray æ£€æµ‹
tail -100 backend.log | grep "Xray"

# é¢„æœŸçœ‹åˆ°
[æ—¶é—´] ğŸ¯ ã€Xrayå¹¶è¡Œæ£€æµ‹ã€‘å¼€å§‹æ£€æµ‹ X ä¸ªåè®®
[æ—¶é—´] ğŸ¯ Xray æ£€æµ‹å®Œæˆ - æ€»è®¡: X, å¯ç”¨: Y
```

---

## ç›¸å…³ä»£ç ä½ç½®

| ä½ç½® | å†…å®¹ | é—®é¢˜ |
|------|------|------|
| L1101-1104 | åè®®åˆ—è¡¨å®šä¹‰ | æ­£ç¡® âœ… |
| L1107-1136 | èŠ‚ç‚¹åˆ†é…é€»è¾‘ | æœ‰é—®é¢˜ âŒ |
| L1215-1217 | Xray èŠ‚ç‚¹ç¡®å®š | æœ‰é—®é¢˜ âŒ |
| L1217 | `if final_xray_nodes:` | æ¡ä»¶ä¸ºå‡ï¼Œè¢«è·³è¿‡ âŒ |

---

## ğŸ“Š å½“å‰ vs ä¿®å¤å

### å½“å‰çŠ¶æ€

```
æ‰€æœ‰èŠ‚ç‚¹: 50 ä¸ª (vmess/vless)
â”œâ”€ Clash æ£€æµ‹: 50 ä¸ª â†’ 0 æˆåŠŸ
â”œâ”€ Xray æ£€æµ‹: 0 ä¸ª (è¢«è·³è¿‡)
â””â”€ æ€»ç»“æœ: 0 æˆåŠŸ âŒ
```

### ä¿®å¤åé¢„æœŸ

```
æ‰€æœ‰èŠ‚ç‚¹: 50 ä¸ª (vmess/vless)
â”œâ”€ Clash æ£€æµ‹: 50 ä¸ª â†’ 0 æˆåŠŸ
â”œâ”€ Xray æ£€æµ‹: 50 ä¸ª (æ¥æ”¶ Clash å¤±è´¥çš„èŠ‚ç‚¹) â†’ å¯èƒ½ 5-20 æˆåŠŸ
â””â”€ æ€»ç»“æœ: 5-20 æˆåŠŸ âœ…
```

---

## âš ï¸ ä¸ºä»€ä¹ˆç°åœ¨æ‰æš´éœ²è¿™ä¸ªé—®é¢˜ï¼Ÿ

### å†å²æƒ…å†µ

è¿™ä¸ªè®¾è®¡åœ¨ä»¥å‰å¯èƒ½æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºï¼š
1. æ—©æœŸèŠ‚ç‚¹æºä¸»è¦æ˜¯ Shadowsocksã€Trojan
2. è¿™äº›åè®®ä¸»è¦ç”± Clash æ”¯æŒï¼ŒXray ä¸æ”¯æŒ
3. æ‰€ä»¥ `xray_nodes_for_test` æ€»æ˜¯æœ‰å†…å®¹

### ç°åœ¨çš„æƒ…å†µ

æœ€è¿‘æ·»åŠ çš„èŠ‚ç‚¹æºéƒ½æ˜¯ vmess/vless ä¸ºä¸»ï¼š
- Epodonios v2ray-configs
- ebrasha free-v2ray-public-list
- æ–°çš„ SS-Collector

**ç»“æœ**: ç°åœ¨ 80% çš„èŠ‚ç‚¹éƒ½æ˜¯ vmess/vlessï¼Œå¯¼è‡´ï¼š
- `clash_nodes_for_test` æœ‰ 1000+ èŠ‚ç‚¹
- `xray_nodes_for_test` å§‹ç»ˆä¸ºç©º
- **Xray æ£€æµ‹æ°¸è¿œè¢«è·³è¿‡**

---

## ğŸ’¡ å…³é”®è®¤çŸ¥

```
è¿™ä¸æ˜¯ Clash å†…æ ¸çš„é—®é¢˜
è¿™ä¸æ˜¯ Xray å†…æ ¸çš„é—®é¢˜
è¿™ä¸æ˜¯ HTTP 502 çš„é—®é¢˜

è¿™æ˜¯ã€èŠ‚ç‚¹åˆ†é…é€»è¾‘ã€‘çš„é—®é¢˜ï¼
```

ä¿®å¤è¿™ä¸ªé—®é¢˜åï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼š
- âœ… Xray èƒ½æ£€æµ‹å‡ºä¸€äº› Clash æ£€æµ‹å¤±è´¥çš„èŠ‚ç‚¹
- âœ… æ€»ä½“æˆåŠŸç‡ä¼šæå‡
- âœ… å……åˆ†åˆ©ç”¨ä¸¤ä¸ªæ£€æµ‹å¼•æ“çš„ä¼˜åŠ¿

---

**è¯Šæ–­æ—¶é—´**: 2025-12-31 21:00
**é—®é¢˜ç¡®è®¤**: âœ… Xray æ£€æµ‹è¢«è·³è¿‡ï¼ŒåŸå› æ˜¯èŠ‚ç‚¹åˆ†é…é€»è¾‘ä¸å®Œå–„
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ (å¯èƒ½æµªè´¹å¤§é‡å¯ç”¨èŠ‚ç‚¹)
**ä¿®å¤éš¾åº¦**: ä¸­ (éœ€è¦çº¦ 10 è¡Œä»£ç æ”¹åŠ¨)
**ä¿®å¤ä¼˜å…ˆçº§**: ğŸ”´ é«˜
